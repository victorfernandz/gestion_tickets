{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento del Ticket {{ ticket.id }}</title>
    <link rel="stylesheet" href="{% static 'tickets/css/style.css' %}">
    <script src="{% static 'tickets/js/script.js' %}" defer></script>
</head>
<body>
    <!-- Barra superior -->
    <header class="navbar">
        <div class="logo">
            <img src="{% static 'tickets/imagenes/logo.jpeg' %}" alt="Logo" class="logo-img">
        </div>
        <div class="navbar-title">
            <h1>Gesti贸n de Tickets - Seguimiento</h1>
        </div>
    </header>

    <!-- Contenido principal --> 
    <div class="container">
        <!-- Sidebar de navegaci贸n -->
        <div class="sidebar">
            <nav>
                <ul>
                    <li><a href="{% url 'home' %}">Inicio</a></li>
                    <li><a href="{% url 'listar_tickets' %}">Tickets</a></li>
                    <li><a href="#">Reportes</a></li>
                    <li><a href="{% url 'administrar_tickets' %}">Administraci贸n</a></li>
                    <li><a href="https://sites.google.com/altamiragroup.com.py/intranet-ag/p%C3%A1gina-principal?authuser=0" target="_blank">Academia AltamiraGroup</a></li>
                </ul>
            </nav>
            <div class="logout-container" style="
                        position: absolute;
                        bottom: 30px;
                        left: 50%;
                        width: 250px; 
                        transform: translateX(-50%);
                        ">
                <a href="{% url 'logout' %}" class="logout-button">Cerrar Sesi贸n</a>
            </div>
        </div>
    </div>

    <!-- rea din谩mica -->
    <main class="content">
        <div class="form-container">
            <h1>Seguimiento del Ticket {{ ticket.id }}</h1>

            <div style="display: flex;">
                <!-- Columna izquierda: detalle, comentarios y lista de archivos -->
                <div class="form-container" style="flex: 1;">
                    <p>
                        <!--<strong>Prioridad:</strong> {{ ticket.get_prioridad_display }} &nbsp;&nbsp;-->
                        <!--<strong>Estado:</strong> {{ ticket.get_estado_display }} &nbsp;&nbsp;-->
                        <strong>Fecha de creaci贸n:</strong> {{ ticket.fecha_creacion|date:"d/m/Y" }}
                    </p>
                    <p><strong>Usuario:</strong> {{ ticket.usuario.nombre }} {{ ticket.usuario.apellido }}</p>
                    <p>
                        <!--<strong>Categor铆a:</strong> {{ ticket.categoria.descripcion }} &nbsp;&nbsp;-->
                        <!--<strong>Tipo de caso:</strong> {{ ticket.tipoCaso.descripcion }}-->
                    </p>
                    <p>
                        <strong>Usuario de soporte asignado:</strong>
                        {% if ticket.admin_asignado %}
                            {{ ticket.admin_asignado.nombre }} {{ ticket.admin_asignado.apellido }}
                        {% else %}
                            No asignado
                        {% endif %}
                    </p>
                    <p><strong>Descripci贸n:</strong> {{ ticket.descripcion }}</p>

                    <!-- Comentarios -->
                    <h2>Comentarios</h2>
                    <ul>
                        {% for comentario in comentarios %}
                            <li>
                                <strong>{{ comentario.usuario.apellido }}, {{ comentario.usuario.nombre }}</strong>: {{ comentario.texto }}
                            </li>
                        {% empty %}
                            <li>No hay comentarios para este ticket.</li>
                        {% endfor %}
                    </ul>

                    <!-- Formulario para agregar comentarios -->
                    <div class="form-group">
                        {% if ticket.estado != 4 %}
                            <h2>Agregar comentario</h2>
                            <form method="post" action="{% url 'seguimiento_ticket' ticket.id %}">
                                {% csrf_token %}
                                <textarea id="comentario" name="comentario" rows="4" placeholder="Escribe un comentario..." required></textarea>
                                <br><br>
                                <button type="submit" class="btn-agregar">Agregar comentario</button>
                            </form>
                        {% endif %}
                    </div>

                    <div>
                     <!-- Formulario para subir archivos -->
                        {% if ticket.estado != 4 %}
                          <h2>Subir archivo</h2>
                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="file" name="archivo" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx" required>
                                <br><br>
                                <button type="submit" class="btn-agregar">Subir archivo</button>
                            </form>   
                        {% endif %}
                    </div>

                    <!-- Mostrar archivos adjuntos (solo lista) -->
                    <h2>Archivos adjuntos</h2>
                    {% if archivos %}
                        <ul>
                            {% for archivo in archivos %}
                                <li>
                                     <a href="{{ archivo.archivo.url }}" target="_blank" download>{{ archivo.archivo.name }}</a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No hay archivos adjuntos.</p>
                    {% endif %}
                </div>

                <!-- Columna derecha: NICA sidebar -->
                 <aside style="width: 320px; min-height: 650px; background: #f1f1f1; padding: 25px; border-left: 1px solid #ccc;">

                    <h3 style="margin-top: 0; margin-bottom: 20px;">Informaci贸n del Ticket</h3>

                    {% if es_admin %}

                        <!--  VERSIN EDITABLE (SOLO ADMIN) -->
                        <form method="POST" action="{% url 'seguimiento_ticket' ticket.id %}">
                            {% csrf_token %}

                            <div style="margin-bottom:12px;">
                                <strong>ID:</strong> {{ ticket.id }}
                            </div>

                            <div style="display:flex; align-items:center; margin-bottom:12px;">
                                <span style="width:130px; font-weight:bold;">Estado:</span>
                                <select name="nuevo_estado" style="flex:1;">
                                    <option value="1" {% if ticket.estado == 1 %}selected{% endif %}>Abierto</option>
                                    <option value="2" {% if ticket.estado == 2 %}selected{% endif %}>En Proceso</option>
                                    <option value="3" {% if ticket.estado == 3 %}selected{% endif %}>En espera</option>
                                    <option value="4" {% if ticket.estado == 4 %}selected{% endif %}>Cerrado</option>
                                </select>
                            </div>

                            <div style="display:flex; align-items:center; margin-bottom:12px;">
                                <span style="width:130px; font-weight:bold;">Prioridad:</span>
                                <select name="nueva_prioridad" style="flex:1;">
                                    <option value="1" {% if ticket.prioridad == 1 %}selected{% endif %}>Bajo</option>
                                    <option value="2" {% if ticket.prioridad == 2 %}selected{% endif %}>Medio</option>
                                    <option value="3" {% if ticket.prioridad == 3 %}selected{% endif %}>Alto</option>
                                    <option value="4" {% if ticket.prioridad == 4 %}selected{% endif %}>Muy Alto</option>
                                </select>
                            </div>

                            <div style="display:flex; align-items:center; margin-bottom:12px;">
                                <span style="width:130px; font-weight:bold;">Agente:</span>
                                <select name="nuevo_admin" style="flex:1;">
                                    <option value="">No asignado</option>
                                    {% for admin in administradores %}
                                        <option value="{{ admin.id }}" {% if ticket.admin_asignado and ticket.admin_asignado.id == admin.id %}selected{% endif %}>
                                            {{ admin.nombre }} {{ admin.apellido }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div style="display:flex; align-items:center; margin-bottom:12px;">
                                <span style="width:130px; font-weight:bold;">Tipo de Caso:</span>
                                <select name="nuevo_tipo_caso" style="flex:1;">
                                    {% for tipo in tipos_caso %}
                                        <option value="{{ tipo.id }}" {% if ticket.tipoCaso.id == tipo.id %}selected{% endif %}>
                                            {{ tipo.descripcion }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div style="display:flex; align-items:center; margin-bottom:12px;">
                                <span style="width:130px; font-weight:bold;">Categor铆a:</span>
                                <select name="nueva_categoria" style="flex:1;">
                                    {% for categoria in categorias %}
                                        <option value="{{ categoria.id }}" {% if ticket.categoria.id == categoria.id %}selected{% endif %}>
                                            {{ categoria.descripcion }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div style="display:flex; align-items:center; margin-bottom:20px;">
                                <span style="width:130px; font-weight:bold;">Tiempo de Resoluci贸n:</span>
                                <input type="datetime-local" name="fecha_hora_resolucion" style="flex:1;"
                                    value="{% if ticket.fecha_hora_resolucion %}{{ ticket.fecha_hora_resolucion|date:'Y-m-d\\TH:i' }}{% endif %}">
                            </div>

                            <div style="display:flex; align-items:center; margin-bottom:20px;">
                                <span style="width:130px; font-weight:bold;">Horario de Asignaci贸n:</span>
                                <input type="datetime-local" name="tiempo_fecha_asignacion" style="flex:1;"
                                    value="{% if ticket.tiempo_fecha_asignacion %}{{ ticket.tiempo_fecha_asignacion|date:'Y-m-d\\TH:i' }}{% endif %}">
                            </div>


                            <button type="submit"
                                style="
                                    display:block;
                                    width:80%;
                                    margin: 25px auto 10px auto;
                                    padding: 10px 0;
                                    background-color: #b7bdb7;
                                    color: #333;
                                    font-weight: bold;
                                    border: none;
                                    border-radius: 5px;
                                    cursor: pointer;
                                ">
                                Actualizar
                            </button>

                        </form>

                    {% else %}

                        <!--  VERSIN SOLO LECTURA (USUARIO NORMAL) -->
                        
                        <p><strong>ID:</strong> {{ ticket.id }}</p>

                        <p><strong>Estado:</strong> {{ ticket.get_estado_display }}</p>

                        <p><strong>Prioridad:</strong> {{ ticket.get_prioridad_display }}</p>

                        <p>
                            <strong>Agente:</strong>
                            {% if ticket.admin_asignado %}
                                {{ ticket.admin_asignado.nombre }} {{ ticket.admin_asignado.apellido }}
                            {% else %}
                                No asignado
                            {% endif %}
                        </p>

                        <p><strong>Tipo de Caso:</strong> {{ ticket.tipoCaso.descripcion }}</p>

                        <p><strong>Categor铆a:</strong> {{ ticket.categoria.descripcion }}</p>

                        <p>
                            <strong>Resoluci贸n:</strong>
                            {% if ticket.fecha_hora_resolucion %}
                                {{ ticket.fecha_hora_resolucion|date:"d/m/Y H:i" }}
                            {% else %}
                                No definido
                            {% endif %}
                        </p>

                        <p>
                            <strong>Hora de Asignaci贸n:</strong>
                            {% if ticket.tiempo_fecha_asignacion %}
                                {{ ticket.tiempo_fecha_asignacion|date:"d/m/Y H:i" }}
                            {% else %}
                                No definido
                            {% endif %}

                    {% endif %}

                    <!--<h3 style="margin-top:25px;">Volver a:</h3>
                    <a href="{% url 'listar_tickets' %}">Mis Tickets</a>-->


                </aside>              
            </div>
        </div>
    </main>
</body>
</html>
